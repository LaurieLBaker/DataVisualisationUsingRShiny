---
title: "Data Visualisation using RShiny"
author: "Laurie Baker, Elaine Ferguson, Will Harvey and Rachel Steenson"
date: "**Tanzania**, August 2019"
output: 
  ioslides_presentation:
    widescreen: true
runtime: shiny
---

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(leaflet)
library(lubridate)
library(dplyr)
library(rgdal)
library(rgeos)

# Load in the raw data
raw_data <- read.csv("data/raw_data.csv", stringsAsFactors=FALSE)

# Add year and decimal date to data
leaflet_data <- raw_data %>% 
  mutate(year = substr(date, 1,4), date=ymd(date), date_decimal = decimal_date(date)) 

## Create a colour palette for points
palette <- c("#231D51", "#178B8B", "#63C963", "#FFE31D")

## Load region shapefile
regions <- readOGR("data/TZ_Region_2012","TZ_Region_2012")

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<style>
div.footnotes {
position: absolute;
bottom: 0;
margin-bottom: 10px;
width: 80%;
font-size: 0.6em;}
.blue {color: #4E23B8;}
.ui-background {background-color: #fcf0cd;}
.server-background {background-color: #dfecfc;}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
$(document).ready(function() {
$('slide:not(.backdrop):not(.title-slide)').append('<div class=\"footnotes\">');

$('footnote').each(function(index) {
var text  = $(this).html();
var fnNum = (index+1).toString();
$(this).html(fnNum.sup());

var footnote   = fnNum + '. ' + text + '<br/>';
var oldContent = $(this).parents('slide').children('div.footnotes').html();
var newContent = oldContent + footnote;
$(this).parents('slide').children('div.footnotes').html(newContent);
});
});
</script>

<!----------------------------------------------------------------------------->
## Course Overview {.smaller}

<h3><b>Day 1:</b></h3>
<ul>
<li> 1.1 Getting to know your data </li>
<li> 1.2 Data subsetting and summarising </li>
<li> 1.3 Build exploratory plots </li>
<li> 1.4 Building an interactive plot in RShiny </li>
</ul>

<h3><b>Day 2:</b></h3>
<ul>
<li> 2.1 Introduction to leaflet </li>
<li> 2.2 Building a leaflet map in R </li>
<li> <b class="blue"> 2.3 Build an interactive map in RShiny </b></li>
</ul>

<h3><b>Day 3:</b></h3>
<ul>
<li> 3.1 Review </li>
<li> 3.2 Build your own apps! </li>
</ul>

<!----------------------------------------------------------------------------->

## Interacting with leaflet maps in Rshiny
  
Some interactive elements (e.g. pop-ups, zoom) are available in leaflet itself.

However, if we want to interactively change which data points or layers will be displayed on the map, we need to bring it into Shiny.

We can use many of the same widgets used to interact with regular plots to interact with leaflet maps!
  

<!----------------------------------------------------------------------------->

## Creating a basic map to build from

``` {r, echo=TRUE}

## Initialise map with tile. Set view and zoom.
m <- leaflet(width=800, height=300) %>% 
  addProviderTiles("Stamen.Terrain") %>%
  setView(c(gCentroid(regions)@coords)[1], c(gCentroid(regions)@coords)[2], 
          zoom = 5)
m
  


```


<!----------------------------------------------------------------------------->

## Creating a basic map to build from

``` {r, echo=TRUE, eval=TRUE}

## Add region shapefile
m <- m %>% 
  addPolygons(data=regions,color="black",fillColor = "white",
              label=regions$Region_Nam, weight=1, fillOpacity=0.7)
m


```

<!----------------------------------------------------------------------------->

## Creating a basic map to build from

``` {r, echo=FALSE, eval=TRUE}


## Add points coloured by species with legend
popupInfo <- 
  paste("Date: ", leaflet_data$date, "<br>",
        "Species: ", leaflet_data$species, "<br>",
        "Age: ", leaflet_data$age, "<br>",
        "Sex: ", leaflet_data$sex, "<br>",
        sep = " ")

pal <- colorFactor(palette, domain = sort(unique(leaflet_data[,"species"])))


```


``` {r, echo=TRUE, eval=TRUE}



m %>% 
  addCircles(data=leaflet_data,lng=~leaflet_data$x,lat=~leaflet_data$y,
             color = pal(leaflet_data[,"species"]), weight=2,
             opacity=1, fillOpacity=1, popup = popupInfo) %>%
  addLegend(position = "bottomright", title = "Species",
            pal = pal, values = leaflet_data[,"species"], opacity=1,
            labFormat = labelFormat(big.mark = "")) 

```

<!----------------------------------------------------------------------------->

## What widgets could we add to make the map more interactive?

<li> <b>selectInput</b> to select alternative variables to colour points by </li><p>
<li> <b>sliderInput</b> to choose date range of plotted points </li><p>
<li> <b>checkboxGroupInput</b> to select which background polygon layers to display </li><p>
<li> <b>pickerInput</b> to choose a subset of the species to plot </li><p>
<li> ... </li>


<!----------------------------------------------------------------------------->




---
title: "Data Visualisation using RShiny"
author: "Laurie Baker, Elaine Ferguson, Will Harvey, and Rachel Steenson"
date: "**Tanzania**, August, 2019"
output: 
  ioslides_presentation:
    incremental: true
    widescreen: true
---

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(leaflet)
library(rgdal)
raw_data <- read.csv("../../Day 1/data/raw_data.csv", stringsAsFactors = FALSE)
region_shp <- readOGR("../../Day 1/data/TZ_Region_2012", "TZ_Region_2012")

# Create a colour palette
col_palette <- c("#231D51", "#178B8B", "#63C963", "#FFE31D") # 2:"#3E507F",
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<style>
div.footnotes {
  position: absolute;
  bottom: 0;
  margin-bottom: 10px;
  width: 80%;
  font-size: 0.6em;
}
.blue {color: #4E23B8;}
.hl1-background {background-color: #fcf0cd;}
.hl2-background {background-color: #dfecfc;}

</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
$(document).ready(function() {
  $('slide:not(.backdrop):not(.title-slide)').append('<div class=\"footnotes\">');

  $('footnote').each(function(index) {
    var text  = $(this).html();
    var fnNum = (index+1).toString();
    $(this).html(fnNum.sup());

    var footnote   = fnNum + '. ' + text + '<br/>';
    var oldContent = $(this).parents('slide').children('div.footnotes').html();
    var newContent = oldContent + footnote;
    $(this).parents('slide').children('div.footnotes').html(newContent);
  });
});
</script>


<!----------------------------------------------------------------------------->
## Course Overview {.smaller}

### **Day 1:**
> - Getting to know your data
> - Data subsetting, summarising
> - Building exploratory plots
> - Building an interactive plot in RShiny

### **Day 2:**
> - <b class="blue"> Introduction to leaflet </b></li>
> - <b class="blue"> Building a leaflet map in R </b></li>
> - Building an interactive map in RShiny

### **Day 3:**
> - Review
> - Build your own apps!

<!----------------------------------------------------------------------------->
## Course Overview {.smaller}

### **Day 1:**
> - Getting to know your data
> - Data subsetting, summarising
> - Building exploratory plots
> - Building an interactive plot in RShiny

### **Day 2:**
> - <b class="blue"> Introduction to leaflet </b></li>
> - <b class="blue"> Building *an interactive* leaflet map in R </b></li>
> - Building an **even more** interactive map in RShiny

### **Day 3:**
> - Review
> - Build your own apps!

<!----------------------------------------------------------------------------->
## Day 2

<ul>
<li> <b class="blue">1.1 Introduction to leaflet </b></li>
<li> 1.2 Building a leaflet map in R </li>
<li> 1.3 Building an interactive map in RShiny </li>
</ul>

<!----------------------------------------------------------------------------->
## Day 2

<ul>
<li> <b class="blue">1.1 Introduction to leaflet </b></li>
<li> 1.2 Building an interactive leaflet map in R </li>
<li> 1.3 Building an *even more* interactive map in RShiny </li>
</ul>

<!----------------------------------------------------------------------------->
## Recap day 1 {.smaller}

Remind ourselves what was in the data

```{r, echo = T}
# Set your working directory by clicking on the top menu:
# Session > Set Working Directory > To Source File Location
raw_data <- read.csv("data/raw_data.csv")
```

<!----------------------------------------------------------------------------->
## Recap day 1 {.smaller}

Reading in data from shape file

```{r, echo = T}
region_shp <- rgdal::readOGR("data/TZ_Region_2012", "TZ_Region_2012")
region_shp$id <- rownames(region_shp@data)
region_shp_df <- fortify(region_shp, region = "id")
region_shp_df <- left_join(region_shp_df, region_shp@data, by = "id")
```

<!----------------------------------------------------------------------------->
## Your Turn

> - Navigate to Day 2/worksheets, and open <b>1.0_worksheet.html</b>

> - All the activities we'll guide you to are in this file.

> - The contents table is interactive - you can click to move to the activity.

<br>

Complete section 2.1a of the worksheet

<!----------------------------------------------------------------------------->
## Map Basics {.smaller}

<b class="blue">How many entries does the data frame have?</b>

```{r, echo = TRUE}
# create variable for type of species
raw_data$species_type[which(raw_data$species=="dog" | raw_data$species=="cat")] <- "Domestic"
raw_data$species_type[which(raw_data$species %in% c("jackal", "lion"))] <- "Wildlife"
raw_data$species_type[which(raw_data$species=="human")] <- "Human"

# Use only one year
map_data <- raw_data %>% 
  dplyr::mutate(year = substr(date, 1,4)) %>% 
  dplyr::filter(year == 2014)
```

<!----------------------------------------------------------------------------->
## Map Basics {.smaller}

The simplest map of this data using base ``plot()``

```{r, echo = TRUE}
plot(map_data$y ~ map_data$x, asp = 1)
```

<!----------------------------------------------------------------------------->
## Map Basics {.smaller}

A simple verion using ``ggplot()`` with points coloured by human population density

```{r, echo = TRUE, fig.height = 4}
ggplot(data = map_data, aes(x = x, y = y, col = density)) +
  geom_point(alpha = 0.4) + # makes points transparent
  coord_equal() # sets aspect ratio 1:1
```

<!----------------------------------------------------------------------------->
# Using leaflet and shape file data

<!----------------------------------------------------------------------------->
## Shape file data {.smaller}
 
```{r, eval = T, echo = T, message = F, fig.height = 4}
region_shp <- rgdal::readOGR(dsn = "data/TZ_Region_2012")
```

<!----------------------------------------------------------------------------->
## Shape file data {.smaller}

Use ``addPolygons()`` to add to leaflet map. ``label = `` determines what will be shown when cursor hovers above area.

```{r, eval = T, echo = T, message = F, fig.height = 4}
leaflet() %>%
  addPolygons(data = region_shp, label = region_shp$Region_Nam,
              color = "grey", weight = 1, fillOpacity = 0.3)
```

<!----------------------------------------------------------------------------->
## Shape file data

Use ``addPolylines()`` to add outlines only to leaflet map.

```{r, eval = T, echo = T, message = F, fig.height = 4}
leaflet() %>%
  addPolylines(data = region_shp, color = "red",  weight = 1)
```

<!----------------------------------------------------------------------------->
## Your turn

Produce a leaflet map using ``addPolygons()`` and ``addPolylines()`` with tiles and circle markers coloured by human population density, a colour legend and a scale bar.

```{r, eval = T, echo = T, message = F, fig.height = 4}
colour_pal <- RColorBrewer::brewer.pal(11, "Spectral")
range(map_data$density)
myPal <- leaflet::colorNumeric(palette = colour_pal, domain = log(map_data$density))
```

<!----------------------------------------------------------------------------->
## Solution {.smaller}

```{r, eval = T, echo = T, message = F, fig.height = 4}
leaflet() %>%
  addProviderTiles(provider = providers$Esri.WorldTopoMap) %>%
  addPolygons(data = region_shp, label = region_shp$Region_Nam,
              color = "grey", weight = 1, fillOpacity = 0.3) %>% 
  addPolylines(data = region_shp, color = "black",  weight = 1) %>% 
  addCircleMarkers(data = map_data, lng = ~x, lat = ~y,
                   radius = 5, fillColor = myPal(log(map_data$density)), fillOpacity = 0.8,
                   weight = 2, color = "grey", opacity = 0.9) %>% 
  addLegend(pal = myPal, values = log(map_data$density), title = "Human<br>population<br>density")
```

<!----------------------------------------------------------------------------->
# Using leaflet and environmental data in raster format

<!----------------------------------------------------------------------------->
## Loading raster data {.smaller}

Load data using raster() from the raster package

```{r, eval = T, echo = T, fig.height = 4}
density <- raster::raster("../../Day 1/data/HumanPopulation.grd")
density
```

<!----------------------------------------------------------------------------->
## Plotting raster data raster data {.smaller}

Load data using raster() from the raster package

```{r, eval = T, echo = T, fig.height = 4}
plot(density)
```

<!----------------------------------------------------------------------------->
## Plotting raster data {.smaller}

Load data using raster() from the raster package

```{r, eval = T, echo = T, fig.height = 4}
plot(log(density))
```

<!----------------------------------------------------------------------------->
## Plotting raster data with leaflet {.smaller}

We use ``colorNumeric()`` again, as we did to colour by date earlier

```{r, eval = T, echo = T, fig.height = 4}
colour_pal <- c("#FFFFCC", "#41B6C4", "#0C2C84")
raster::values(density) %>% range(na.rm = T)
myPal <- colorNumeric(palette = colour_pal, domain = c(0, 30000), na.color = "red")

m <- leaflet() %>%
  addRasterImage(x = density, colors = myPal, opacity = 0.8)
```

<!----------------------------------------------------------------------------->
## Plotting raster data with leaflet {.smaller}

```{r, eval = T, echo = F, fig.height = 4}
m
```

<!----------------------------------------------------------------------------->
## Plotting raster data with leaflet {.smaller}

Let's log density as we did before

```{r, eval = T, echo = T, fig.height = 3.5}
raster::values(density) %>% range(na.rm = T) %>% log
myPal <- colorNumeric(palette = colour_pal, domain = c(-1.5, 11),
                      na.color = "transparent")
```

We have to exclude some data, as there are 0 density polygons and log(0) gives -infinity

```{r, eval = T, echo = T, fig.height = 3.5}
sum(raster::values(density) > exp(-1.5), na.rm = T) /
  sum(raster::values(density) >= 0, na.rm = T)
```


<!----------------------------------------------------------------------------->
## Plotting raster data with leaflet {.smaller}


Plot the logged raster data with some tiles and a legend for the colour scheme.

```{r, eval = T, echo = T, fig.height = 3.5}
m <- leaflet() %>%
  addProviderTiles(provider = providers$CartoDB.Positron) %>%
  addRasterImage(x = log(density), colors = myPal, opacity = 0.8) %>%
  addLegend(pal = myPal, values = c(-1.5, 11), opacity = 0.8,
            title = "Human<br>population<br>density")
```

<!----------------------------------------------------------------------------->
## Plotting raster data with leaflet {.smaller}

```{r, eval = T, echo = F, fig.height = 4}
m
```

<!----------------------------------------------------------------------------->
## Plotting raster data with leaflet {.smaller}


Instead of using ``addProviderTiles(provider = providers$CartoDB.Positron)``

We order things here so that we plot<br>1) The background tiles (``providers$CartoDB.PositronNoLabels``) only first<br>2) Then the raster data<br>3) and finally the labels (``providers$CartoDB.PositronOnlyLabels``) on top of that

```{r, eval = T, echo = T, fig.height = 3.5}
m <- leaflet() %>%
  addProviderTiles(provider = providers$CartoDB.PositronNoLabels) %>%
  addRasterImage(x = log(density), colors = myPal, opacity = 0.8) %>%
  addProviderTiles(provider = providers$CartoDB.PositronOnlyLabels) %>%
  addLegend(pal = myPal, values = c(-1.5, 11), opacity = 0.8,
            title = "Human<br>population<br>density")
```

<!----------------------------------------------------------------------------->
## Plotting raster data with leaflet {.smaller}

```{r, eval = T, echo = F, fig.height = 4}
m
```

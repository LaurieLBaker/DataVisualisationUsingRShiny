---
title: "Data Visualisation using RShiny"
author: "Rachel Steenson, Elaine Ferguson, Will Harvey, and Laurie Baker"
date: "**Tanzania**, August, 2019"
output: 
  ioslides_presentation:
    incremental: true
---

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(leaflet)
library(rgdal)
raw_data <- read.csv("data/raw_data.csv", stringsAsFactors = FALSE)
region_shp <- readOGR("data/TZ_Region_2012", "TZ_Region_2012")

# Create a colour palette
col_palette <- c("#231D51", "#178B8B", "#63C963", "#FFE31D") # 2:"#3E507F",
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<style>
div.footnotes {
  position: absolute;
  bottom: 0;
  margin-bottom: 10px;
  width: 80%;
  font-size: 0.6em;
}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
$(document).ready(function() {
  $('slide:not(.backdrop):not(.title-slide)').append('<div class=\"footnotes\">');

  $('footnote').each(function(index) {
    var text  = $(this).html();
    var fnNum = (index+1).toString();
    $(this).html(fnNum.sup());

    var footnote   = fnNum + '. ' + text + '<br/>';
    var oldContent = $(this).parents('slide').children('div.footnotes').html();
    var newContent = oldContent + footnote;
    $(this).parents('slide').children('div.footnotes').html(newContent);
  });
});
</script>


## Background

### **What is RShiny?**

> - "Shiny is an R package that makes it easy to build interactive web applications (apps) straight from R."

### **Why build interactive graphics?**

> - To explore and discover data
> - Communicate your results to colleagues, stakeholders, managers
> - Allow others to explore their own hypotheses

## Course Overview

### **Day 1:**
> - Getting to know your data
> - Data subsetting, summarising and exploratory plots
> - Build an interactive exploratory plot in RShiny

### **Day 2:**
> - Introduction to leaflet
> - Building a leaflet map in R
> - Build an interactive map in RShiny

### **Day 3:**
> - Review
> - Build your own apps!

## Daily Schedule

### **Morning Session**
> - Part 1
> - Break: tea and coffee
> - Part 2
  
### **Lunch**

### **Afternoon Session**
> - Part 3
> - Afternoon tea
> - Part 4

## Getting Help

```{r, out.width = "500px", out.height = "500px"}
library(png)
knitr::include_graphics("figures/sticky notes.jpg")
 
```

## Deadly virus spreads through Tanzania!


```{r, out.width = "760px", out.height = "380px"}
library(png)
knitr::include_graphics("figures/headline.png")
 
```

> - **Your mission**: visualise the disease advance and save the wildlife and citizens of Tanzania!!

## Getting to know the data

Step 1: Set the working directory

```{r, echo = T}
# Set your working directory by clicking on the top menu:
# Session > Set Working Directory > To Source File Location
```

Step 2: Install and load packages

```{r, echo = T, eval = FALSE}
install.packages("dplyr")
library("dplyr")
```


Step 3: Read in the data
```{r, echo = T, eval = F}
raw_data <- read.csv("data/raw_data.csv")
```

```{r, include = F}
library("dplyr")
```


## Getting to know the data

We have several tools to get to know our data

- ``View()``: allows us to view the dataframe as a spreadsheet.
- ``names()``: give us the names of the columns in our data frame
- ``dim()``: tells us the dimensions of our dataframes. 
- ``summary()``: give us summary statistics (counts, min, median, mean, max).
- ``head()``: gives us the first 6 elements of the data
- ``tail()``: gives us the last 6 elements of the data
- ``str()``: tells us the variable type (e.g. Factor, num (number), int (integer))
- ``unique()``: tells us the unique elements of a variable. 
- ``?`` and ``??`` accesses the help file for a function.

## Your Turn

> - ``View(raw_data)``: how many entries does the data frame have?
> - ``names(raw_data)``: what are the names of the first 3 columns?
> - ``dim(raw_data)``: what are the dimensions of our data?
> - ``summary(raw_data)``: which species had more cases? What is the mean age of everything infected?
> - ``head(raw_data)``: In which region did the 1st case occur?
> - ``tail(raw_data)``: In which region did the last case occur?
> - ``str(raw_data)``: Which variables are numbers (num)?
> - ``unique(raw_data$species)``: What are the unique elements of a variable?
> - ``?names()``: What is the first argument for the function names?

## ``View()``, ``names()``, ``dim()``

How many entries does the data frame have?

```{r, echo = TRUE}

View(raw_data)

```

What are the names of the first 3 columns?

```{r, echo = TRUE}

names(raw_data)

```

What are the dimensions of our data?

```{r, echo = TRUE}

dim(raw_data)

```

## ``summary()`` 

Which species has more cases? What is the mean age of those infected?

```{r, echo = TRUE}

summary(raw_data)

```


## ``head()``, ``tail()``

In which region did the 1st case occur?

```{r, echo = TRUE}

head(raw_data, 1)

```

In which region did the last case occur?

```{r, echo = TRUE}

tail(raw_data, 1)

```


## ``str()``

Which variables are numbers (have num written next to them)?
```{r, echo = T}

str(raw_data)

```


## ``unique()``, ``?names()`` 

What types of species do we have in our dataset?
```{r, echo = T}

unique(raw_data$species)

```

What is the first argument for the function ``names()`` 

```{r, out.width = "400px", out.height = "300px"}
library(png)
knitr::include_graphics("figures/names_info.png")
 
```

# Data subsetting and summarising

## Data subsetting and summarising

To understand the outbreak we may want to look more closely at a particular **region**, **time**, or **variable**. 

The ``dplyr`` package allows us to filter and select different elements using **verbs**:

 - ``select()`` picks variables based on their names.
 - ``filter()`` picks cases based on their values.
 - ``summarise()`` reduces multiple values down to a single summary.
 - ``mutate()`` adds new variables that are functions of existing variables

## ``dplyr`` and the piping function ``%>%``

In ``dplyr`` you can use the piping function %>% where 

```{r, eval = F, echo = T}
filter(raw_data, region == "Pwani")

```

Is the same as

```{r, eval = F, echo = T}

raw_data %>% 
  filter(region == "Pwani")

```

Similar to regular R you can use the ``<-`` or ``=`` to store the object

```{r, eval = F, echo = T}
species_df <- raw_data %>%
                      select(species, date, age)

``` 

## Selecting columns using ``select()`` 

``select()`` picks variables based on their names.

```{r, eval = T, echo = T}
species_df1 <- raw_data %>% 
    select(species)

head(species_df1, 1)

species_df3 <- raw_data %>%
    select(species, region, sex)

head(species_df3, 1)

```


## Selecting rows using ``filter()`` 

``filter()`` picks cases based on their values.

To select the observations you want it is useful to know some comparison operators

  - ``>`` **greater than**
  - ``>=`` **greater than or equal to**
  - ``!=`` **not equal**
  - ``==`` **equal**
  - ``&`` **and**
  - ``|`` **or**
  - ``!`` **not**
  - ``%in% c(....)`` **one in** a list of elements

## Selecting rows using ``filter()`` 

Filter by value that is equal to

```{r, eval = T, echo = T}
pwani_df <- raw_data %>% 
    filter(region == "Pwani")
```

Filter by value that is less than

```{r, eval = T, echo = T}
early_df <- raw_data %>%
    filter(month < 40)
```

Filter by value that is not equal to OR keep values in a list

```{r, eval = T, echo = T}
human_wild_animal_df <- raw_data %>%
    filter(species != "cat" & species != "dog") 
```


```{r, eval = T, echo = T}
human_wild_animal_df <- raw_data %>%
    filter(species %in% c("jackal", "lion")) 
```


## Using **summarise()**

``summarise()`` reduces multiple values down to a single summary.

```{r, eval = T, echo = T}
raw_data %>% 
    summarise(mean_age = mean(age)) # mean() takes the average

raw_data %>% 
    summarise(total_cases = n()) # n() takes the number of elements


```

## Using **mutate()**

**mutate()** adds new variables that are functions of existing variables

```{r, eval = T, echo = T}
raw_data_df <- raw_data %>% 
    mutate(animal_type = ifelse(species == "human", "human", "animal")) 

head(raw_data_df)
```

## Combining multiple operations

Number of cases from domestic and wild animals in Pwani. 

```{r, eval = T, echo = T}
pwani_df <- raw_data %>%
              filter(region == "Pwani")
pwani_non_human <- pwani_df %>%
                      filter(species != "human")
pwani_non_human <- pwani_non_human %>%
                      mutate("animal_type" = ifelse(species 
                      %in% c("dog", "cat"), "domestic", "wild"))
pwani_grouped<- pwani_non_human %>%
      group_by(animal_type)

pwani_grouped %>% summarise(n())
```
      


## Combining multiple operations

Or we can use the piping function ``%>%``

```{r, eval = T, echo = T}
raw_data %>% 
  filter(region == "Pwani", species != "human") %>% 
  mutate("animal_type" = ifelse(species %in% c("dog", "cat"), 
          "domestic", "wild")) %>% 
  group_by(animal_type) %>% 
  summarise(n())
```


## Your Turn

Complete section 1.2.1-1.2.3 of the handout. 

## Your Turn - Results section 1.2.1

What do each of these lines of code filter the data for?

```{r, eval=FALSE, echo = T}
raw_data %>% 
  filter(region %in% c("Mara", "Pwani", "Dar-es-salaam"))

raw_data %>% 
  filter(age >= 30)
```


## Your Turn - Results section 1.2.2

<p class="question">What do each of the following filters summarise?</p>
```{r, eval=T, echo = T}
raw_data %>% 
  summarise(n_males = length(which(sex=="M")))

raw_data %>% 
  summarise(total_age = sum(age))
```


## Your Turn - Results section 1.2.3

Fill in the blanks for the following lines in your R

```{r, eval = F, echo = T}
# Subset for only records with a dog 
raw_data %>%
  filter(species == "dog") #filter
```

```{r, eval = F, echo = T}
# Subset for humans, and summarise the mean age per region
raw_data %>%
  filter(species == "human") %>% #filter
  group_by(region) %>% #region
  summarise(mean_age = mean(age)) #summarise, mean()
```


# Making exploratory plots

## Loading some new packages

```{r, eval = F, echo = T}

install.packages("ggplot2", "lubridate", "leaflet")

library(ggplot2)
library(lubridate)
library(leaflet)

```


```{r, echo = FALSE}
library(ggplot2)
library(lubridate)
library(leaflet)
```

## Introducing ggplot

The basic structure:  

ggplot() + <br>
&nbsp;&nbsp;&nbsp;geom_bar(data=raw_data, aes(x=sex))

## Introducing ggplot - plots

First we need to specify a plot

ggplot() + <br>
&nbsp;&nbsp;&nbsp;<b style="color:red;">geom_bar</b>(data=raw_data, aes(x=sex))



  - ggplot has several plot types:
    - <b style="color:red;">geom_bar</b>: **barplot**
    - <b style="color:red;">geom_hist</b>: **histogram**
    - <b style="color:red;">geom_point</b>: **scatterplot/points**
    - <b style="color:red;">geom_line</b>: **line plot**

## Introducing ggplot - data

Second we need to supply our data

ggplot() + <br>
&nbsp;&nbsp;&nbsp;<b style="color:red;">geom_bar</b>(<b style="color:blue;">data=raw_data</b>, aes(x=sex))


The data can also be specified here:

ggplot(<b style="color:blue;">data=raw_data</b>) + <br>
&nbsp;&nbsp;&nbsp;<b style="color:red;">geom_bar</b>(aes(x=sex))


## Introducing ggplot - aesthetics


Third, we specify the variables we want to plot using aesthetics, or aes().

ggplot() + <br>
&nbsp;&nbsp;&nbsp;<b style="color:red;">geom_bar</b>(<b style="color:blue;">data=raw_data</b>, <b style="color:green;">aes(x=sex)</b>)

  
Different plots take different arguments in aes()

ggplot() + <br>
&nbsp;&nbsp;&nbsp;<b style="color:red;">geom_point</b> takes <b style="color:green;">aes(x=sex, y = age)</b>

## Barplot

```{r, echo = T, out.width = "100%"}
ggplot() + 
  geom_bar(data=raw_data, aes(x=sex))
```

## Introducing ggplot - aesthetics

Change the colour in aesthetics

```{r, echo = T, out.width = "80%"}
ggplot() +  
  geom_bar(data=raw_data, aes(x=sex, fill = "red"))  
```

## Introducing ggplot - aesthetics

Change the colour in aesthetics by variable

```{r, echo = T, out.width = "80%"}
ggplot() +
  geom_bar(data=raw_data, aes(x=sex, fill = sex))
``` 

## Introducing ggplot - additional features

Adding **labels**, **titles**, and **themes**

```{r, eval = F, echo = T, out.width = "80%"}
ggplot() + 
  geom_bar(data=raw_data, aes(x=sex, fill=sex))+ 
  xlab("Sex") + # Label for the X axis
  ylab("Cases") + # Label for the Y axis
  ggtitle("Disease cases by Sex") + #Title
  theme_classic() # Plot theme for background etc.
``` 


## Your turn - 1.3.1 and 1.3.2

Create a barplot of species and colour by species. 

```{r, eval = F, echo = T}
ggplot() + 
  geom_bar(data=raw_data, aes(x=________, fill = ________)) + 
  theme_classic()
```

Add labels to your plot
```{r, eval = F, echo = T}
ggplot() + 
  geom_bar(data=raw_data, aes(x=________, fill = ________)) + 
  _________ +
  _________ +
  _________ +
  theme_classic()
```


## Your turn - Results 1.3.1, 1.3.2

```{r, eval = F, echo = T}
ggplot() + 
  geom_bar(data=raw_data, aes(x=species, fill = species)) + 
  theme_classic()
```

```{r, eval = F, echo = T}
ggplot() + 
  geom_bar(data=raw_data, aes(x=species, fill = species))+ 
  xlab("Sex") +
  ylab("Cases") +
  ggtitle("Disease cases by Species") +
  theme_classic()
```

## Your turn - Results 1.3.1, 1.3.2


```{r, eval = T, echo = F}
ggplot() + 
  geom_bar(data=raw_data, aes(x=species, fill = species))+ 
  xlab("Sex") +
  ylab("Cases") +
  ggtitle("Disease cases by Species") +
  theme_classic()
```
